<!-- app.component.html -->
<div class="app-container">
  <div class="app-title">–°–∏—Å—Ç–µ–º–∞ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–∏—Ö –≥—Ä–∞—Ñ—ñ–∫—ñ–≤</div>

  <!-- –°–µ–∫—Ü—ñ—è 1: –ì—Ä–∞—Ñ—ñ–∫ —ñ –æ—Å–Ω–æ–≤–Ω—ñ –∫–æ–Ω—Ç—Ä–æ–ª–∏ -->
  <div class="section chart-controls">
    <div class="section-title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞</div>
    <div class="controls">
      <!-- –í–∞–ª—é—Ç–∞ -->
      <div class="control-group">
        <label>–í–∞–ª—é—Ç–∞</label>
        <ng-select class="custom-select" [items]="symbols" bindLabel="label" bindValue="value" [clearable]="false"
          [(ngModel)]="selectedSymbol" (change)="onSymbolChange($event)">
        </ng-select>
      </div>

      <!-- –ü–µ—Ä—ñ–æ–¥ (–î—ñ–∞–ø–∞–∑–æ–Ω –¥–∞–Ω–∏—Ö) -->
      <div class="control-group">
        <label>–ü–µ—Ä—ñ–æ–¥</label>
        <ng-select class="custom-select" [items]="timeRanges" bindLabel="label" bindValue="value" [clearable]="false"
          [(ngModel)]="selectedTimeRange" (change)="onTimeRangeChange($event)">
        </ng-select>
      </div>

      <!-- –¢–∞–π–º—Ñ—Ä–µ–π–º -->
      <div class="control-group">
        <label>–¢–∞–π–º—Ñ—Ä–µ–π–º</label>
        <ng-select class="custom-select" [items]="timeFrames" bindLabel="label" bindValue="value" [clearable]="false"
          [(ngModel)]="timeFrame" (change)="onTimeFrameChange($event)">
        </ng-select>
      </div>

      <!-- –Ü–Ω—Ç–µ—Ä–≤–∞–ª –æ–Ω–æ–≤–ª–µ–Ω–Ω—è -->
      <div class="control-group">
        <label>–Ü–Ω—Ç–µ—Ä–≤–∞–ª –æ–Ω–æ–≤–ª–µ–Ω–Ω—è</label>
        <ng-select class="custom-select" [items]="refreshIntervals" bindLabel="label" bindValue="value"
          [clearable]="false" [(ngModel)]="selectedRefreshInterval" (change)="onRefreshIntervalChange($event)">
        </ng-select>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö -->
      <div class="control-group">
        <button class="action-button" (click)="fetchChartData()">
          –û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ
        </button>
      </div>
    </div>
  </div>

  <!-- –ì—Ä–∞—Ñ—ñ–∫ -->
  <div class="chart-wrapper">
    <app-chart [chartData]="chartData" [selectedSymbol]="selectedSymbol" [timeFrame]="timeFrame"
      [patternSignals]="patternSignals" [isLiveAnalysisRunning]="isLiveAnalysisRunning"
      [refreshInterval]="selectedRefreshInterval / 1000">
    </app-chart>
  </div>

  <!-- –°–µ–∫—Ü—ñ—è 2: –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ —Ç–∞ –õ–∞–π–≤-–∞–Ω–∞–ª—ñ–∑ -->
  <div class="section analysis-section">
    <div class="section-title">–Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</div>

    <!-- –ü–∞–Ω–µ–ª—å —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ -->
    <div class="indicators-panel">
      <div class="indicator-card pressure-down" [class.active]="pressureDownActive">
        <div class="indicator-header">
          <h4>üìâ Pressure Down</h4>
          <span class="indicator-status" [class.active]="pressureDownActive">
            {{pressureDownActive ? '–ê–∫—Ç–∏–≤–Ω–∏–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π'}}
          </span>
        </div>
        <div class="indicator-metrics" *ngIf="pressureDownActive">
          <div class="metric">
            <span class="label">–ü–∞–¥—ñ–Ω–Ω—è:</span>
            <span class="value negative">{{currentDropPercent}}%</span>
          </div>
          <div class="metric">
            <span class="label">–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å:</span>
            <span class="value">{{pressureIntensity}}</span>
          </div>
          <div class="metric">
            <span class="label">–ß–µ—Ä–≤–æ–Ω–∏—Ö —Å–≤—ñ—á–æ–∫:</span>
            <span class="value">{{redCandlesCount}}</span>
          </div>
        </div>
      </div>

      <div class="indicator-card recovery-tracker" [class.active]="recoveryTrackerActive">
        <div class="indicator-header">
          <h4>üìà Recovery Tracker</h4>
          <span class="indicator-status" [class.active]="recoveryTrackerActive">
            {{recoveryTrackerActive ? '–ê–∫—Ç–∏–≤–Ω–∏–π' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∏–π'}}
          </span>
        </div>
        <div class="indicator-metrics" *ngIf="recoveryTrackerActive">
          <div class="metric">
            <span class="label">–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è:</span>
            <span class="value positive">{{recoveryPercent}}%</span>
          </div>
          <div class="metric">
            <span class="label">–®–≤–∏–¥–∫—ñ—Å—Ç—å:</span>
            <span class="value">{{recoverySpeed}}%/—Å–≤</span>
          </div>
          <div class="metric">
            <span class="label">–í—ñ–¥ —Å—Ç–∞—Ä—Ç—É:</span>
            <span class="value" [class.positive]="+fromStartPercent > 0" [class.negative]="+fromStartPercent < 0">
              {{fromStartPercent}}%
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- –ù–æ–≤–∏–π —Ä–æ–∑–¥—ñ–ª: –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ -->
    <div class="subsection">
      <div class="subsection-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑</div>

      <!-- –ö–Ω–æ–ø–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É -->
      <div class="action-buttons">
        <button class="action-button" (click)="analyzeData()" [disabled]="isAnalyzing">
          {{isAnalyzing ? '–í–∏–∫–æ–Ω—É—î—Ç—å—Å—è –∞–Ω–∞–ª—ñ–∑...' : '–ó–∞–ø—É—Å—Ç–∏—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–Ω–∏–π –∞–Ω–∞–ª—ñ–∑'}}
        </button>
      </div>

      <!-- –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
      <div class="loading-indicator" *ngIf="isAnalyzing">
        –ê–Ω–∞–ª—ñ–∑ –ø–∞—Ç–µ—Ä–Ω—ñ–≤ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å –∑ Binance...
      </div>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª—ñ–∑—É -->
      <div class="analysis-results" *ngIf="autoAnalysisResult">
        <div class="analysis-summary">
          <div class="analysis-info">
            <span>–î–∞–Ω—ñ: {{autoAnalysisResult.dataSource}}</span>
            <span>–ü–µ—Ä—ñ–æ–¥: {{autoAnalysisResult.analysisPeriod}}</span>
            <span>–ü—Ä–æ–∞–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–æ {{autoAnalysisResult.totalPatternsAnalyzed}} –ø–∞—Ç–µ—Ä–Ω—ñ–≤</span>
            <span class="indicator-badge">{{autoAnalysisResult.indicatorAnalysis}}</span>
          </div>

          <div class="success-message" *ngIf="autoAnalysisResult.bestPatterns.length > 0">
            <span>–ó–Ω–∞–π–¥–µ–Ω–æ {{autoAnalysisResult.bestPatterns.length}} –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤!</span>
          </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü—è –Ω–∞–π–∫—Ä–∞—â–∏—Ö –ø–∞—Ç–µ—Ä–Ω—ñ–≤ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ -->
        <div class="best-patterns-table-container" *ngIf="autoAnalysisResult.bestPatterns.length > 0">
          <h4>–ù–∞–π–µ—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—à—ñ –ø–æ—Ä–æ–≥–∏ —Å–ø–∞–¥—É (–º—ñ–Ω—ñ–º—É–º 3%)</h4>
          <table class="patterns-table">
            <thead>
              <tr>
                <th>–ü–æ—Ä—ñ–≥ —Å–ø–∞–¥—É (%)</th>
                <th>–£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å (%)</th>
                <th>–°–µ—Ä. –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (%)</th>
                <th>–ú–∞–∫—Å. –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (%)</th>
                <th>–®–≤–∏–¥–∫—ñ—Å—Ç—å –≤—ñ–¥–Ω–æ–≤–ª.</th>
                <th>–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å —Ç–∏—Å–∫—É</th>
                <th>–ö-—Å—Ç—å –ø–∞—Ç–µ—Ä–Ω—ñ–≤</th>
                <th>–î—ñ—è</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let pattern of autoAnalysisResult.bestPatterns">
                <td>‚â•{{pattern.dropThreshold}}</td>
                <td [style.color]="pattern.successRate > 50 ? '#00e396' : '#ff4560'">
                  {{pattern.successRate}}%
                </td>
                <td>{{pattern.averageReversalPercent}}%</td>
                <td>{{pattern.maxReversalPercent}}%</td>
                <td>{{pattern.averageRecoverySpeed}}%/—Å–≤</td>
                <td>{{pattern.averagePressureIntensity}}</td>
                <td>{{pattern.patternsCount}}</td>
                <td>
                  <button class="action-button" (click)="useLiveAnalysisParams(pattern)">
                    –ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <p class="info-text">–î–∞–Ω—ñ: –æ—Å—Ç–∞–Ω–Ω—ñ–π –º—ñ—Å—è—Ü—å –∑ Binance API (–∫–µ—à—É—é—Ç—å—Å—è –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏)</p>
        </div>

        <!-- –ü—Ä–∏–∫–ª–∞–¥–∏ –ø–∞—Ç–µ—Ä–Ω—ñ–≤ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ (–º–∞–∫—Å–∏–º—É–º 3) -->
        <div class="pattern-examples-container" *ngIf="autoAnalysisResult.bestPatterns.length > 0 && autoAnalysisResult.bestPatterns[0].examples">
          <h4>–ü—Ä–∏–∫–ª–∞–¥–∏ —Å–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ (–ø–æ—Ä—ñ–≥ {{autoAnalysisResult.bestPatterns[0].dropThreshold}}%)</h4>
          <table class="patterns-table">
            <thead>
              <tr>
                <th>–ß–∞—Å</th>
                <th>–¶—ñ–Ω–∞</th>
                <th>–ü–∞–¥—ñ–Ω–Ω—è (%)</th>
                <th>–í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (%)</th>
                <th>–Ü–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å</th>
                <th>–®–≤–∏–¥–∫—ñ—Å—Ç—å</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let example of autoAnalysisResult.bestPatterns[0].examples">
                <td>{{example.time | date:'dd.MM.yyyy HH:mm'}}</td>
                <td>{{example.price | number:'1.2-2'}}</td>
                <td [style.color]="'#ff4560'">{{example.dropPercent}}%</td>
                <td [style.color]="example.reversalPercent > 0 ? '#00e396' : '#ff4560'">
                  {{example.reversalPercent}}%
                </td>
                <td>{{example.pressureIntensity}}</td>
                <td>{{example.recoverySpeed}}%/—Å–≤</td>
              </tr>
            </tbody>
          </table>

          <div class="interpretation-box" *ngIf="autoAnalysisResult.interpretation">
            <h5>üìä –Ü–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü—ñ—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤:</h5>
            <p><strong>{{autoAnalysisResult.interpretation['bestThreshold']}}</strong></p>
            <p>{{autoAnalysisResult.interpretation['successRate']}}</p>
            <p>{{autoAnalysisResult.interpretation['averageRecovery']}}</p>
            <p>{{autoAnalysisResult.interpretation['recoverySpeed']}}</p>
            <p class="recommendation">{{autoAnalysisResult.interpretation['recommendation']}}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- –ü—ñ–¥—Å–µ–∫—Ü—ñ—è: –õ–∞–π–≤-–∞–Ω–∞–ª—ñ–∑ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ -->
    <div class="subsection">
      <div class="subsection-title">–õ–∞–π–≤-–∞–Ω–∞–ª—ñ–∑ –∑ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏</div>

      <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ -->
      <div class="controls">
        <div class="control-group">
          <label>–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –ø–æ—Ä—ñ–≥ —Å–ø–∞–¥—É (%)</label>
          <input type="number" class="custom-input" [(ngModel)]="significantDropThreshold"
            (ngModelChange)="onSignificantDropThresholdChange($event)" min="3" max="20" step="0.5">
          <small>–ú—ñ–Ω—ñ–º—É–º 3% –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤</small>
        </div>

        <div class="control-group">
          <label>–ú–∞–∫—Å. –∑–µ–ª–µ–Ω–∏—Ö —Å–≤—ñ—á–æ–∫ (–¥–ª—è —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—ó)</label>
          <input type="number" class="custom-input" [(ngModel)]="maxGreenCandles"
            (ngModelChange)="onMaxGreenCandlesChange($event)" min="1" max="10">
        </div>
      </div>

      <!-- –°—Ç–∞—Ç—É—Å –ª–∞–π–≤-–∞–Ω–∞–ª—ñ–∑—É -->
      <div class="status">
        <p class="status-indicator" [class.active]="isLiveAnalysisRunning">
          <span *ngIf="isLiveAnalysisRunning">
            –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –∞–∫—Ç–∏–≤–Ω—ñ ({{selectedSymbol}} {{timeFrame}})
            <span class="indicators-info">
              PD: {{pressureDownActive ? 'ON' : 'OFF'}} | RT: {{recoveryTrackerActive ? 'ON' : 'OFF'}}
            </span>
          </span>
          <span *ngIf="!isLiveAnalysisRunning">–Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ</span>
        </p>
        <p class="loading-indicator" *ngIf="isLiveAnalysisLoading">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤...</p>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥—ñ–π -->
      <div class="action-buttons">
        <button class="action-button"
          (click)="startLiveAnalysis({ maxGreenCandles: maxGreenCandles, minConsecutiveCandles: 0, significantDropThreshold: significantDropThreshold })"
          [disabled]="isLiveAnalysisRunning || isLiveAnalysisLoading">
          –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏
        </button>

        <button class="action-button stop-button" (click)="stopLiveAnalysis()" [disabled]="!isLiveAnalysisRunning">
          –ó—É–ø–∏–Ω–∏—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏
        </button>

        <button class="action-button clear-button" (click)="clearSignals()" [disabled]="liveSignals.length === 0">
          –û—á–∏—Å—Ç–∏—Ç–∏ —Å–∏–≥–Ω–∞–ª–∏
        </button>
      </div>

      <!-- –°–∏–≥–Ω–∞–ª–∏ –≤—ñ–¥ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ -->
      <div class="signals" *ngIf="liveSignals.length > 0">
        <h3>–°–∏–≥–Ω–∞–ª–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ–≤ ({{liveSignals.length}})</h3>
        <ul>
          <li *ngFor="let signal of liveSignals" [class.pressure-signal]="signal.type === 'Signal'"
              [class.recovery-signal]="signal.type.includes('Reversal')">
            <strong>{{signal.time | date:'HH:mm:ss'}}</strong> -
            <span class="signal-type">
              {{signal.type === 'Signal' ? 'üìâ Pressure Down' : 
                signal.type === 'ReversalSignal' ? 'üìà Recovery Start' :
                signal.type === 'ReversalUpdate' ? 'üìä Recovery Update' :
                signal.type === 'ReversalComplete' ? '‚úÖ Recovery Complete' : signal.type}}:
            </span>
            {{signal.message || ''}}
            <span *ngIf="signal.reversalChance" class="reversal-chance"
                  [style.color]="parsePercentValue(signal.reversalChance) > 70 ? '#00e396' : '#ffa500'">
              (–®–∞–Ω—Å: {{signal.reversalChance}})
            </span>
          </li>
        </ul>
      </div>

      <p class="info-text" *ngIf="liveSignals.length === 0 && isLiveAnalysisRunning">
        –Ü–Ω–¥–∏–∫–∞—Ç–æ—Ä–∏ –º–æ–Ω—ñ—Ç–æ—Ä—è—Ç—å —Ä–∏–Ω–æ–∫. –û—á—ñ–∫—É–≤–∞–Ω–Ω—è —Å–∏–≥–Ω–∞–ª—ñ–≤...
      </p>
    </div>
  </div>
</div>